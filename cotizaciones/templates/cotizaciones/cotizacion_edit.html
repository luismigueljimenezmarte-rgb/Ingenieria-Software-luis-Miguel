{% extends "cotizaciones/base.html" %}
{% block title %}Editar cotización{% endblock %}

{% block content %}
<div class="card">
  <h3 style="margin-top:0;">Editar cotización #{{ cotizacion.id }}</h3>

  <form method="post">
    {% csrf_token %}

    {% if form.errors %}
      <div class="card" style="border:1px solid #ef4444;">
        <b>Errores en la cotización:</b> {{ form.errors }}
      </div>
    {% endif %}

    {% if formset.non_form_errors %}
      <div class="card" style="border:1px solid #ef4444;">
        <b>Errores generales:</b> {{ formset.non_form_errors }}
      </div>
    {% endif %}

    {% if formset.errors %}
      <div class="card" style="border:1px solid #ef4444;">
        <b>Errores en detalles:</b> {{ formset.errors }}
      </div>
    {% endif %}

    <div class="row">
      <div style="flex:1; min-width:260px;">
        <label>Cliente</label>
        {{ form.cliente }}
      </div>
      <div style="flex:1; min-width:260px;">
        <label>Fecha</label>
        {{ form.fecha }}
      </div>
    </div>

    <div class="row">
      <div style="flex:1; min-width:260px;">
        <label>Nombre del proyecto</label>
        {{ form.nombre_proyecto }}
      </div>
      <div style="flex:1; min-width:260px;">
        <label>Tipo de obra</label>
        {{ form.tipo_obra }}
      </div>
      <div style="flex:1; min-width:260px;">
        <label>Ubicación</label>
        {{ form.ubicacion }}
      </div>
    </div>

    <div style="margin-top:10px;">
      <label>Notas</label>
      {{ form.notas }}
    </div>

    <hr style="margin:18px 0; border:none; border-top:1px solid #e5e7eb;">

    <h4>Detalles</h4>
    <div class="muted" style="margin-bottom:10px;">
      Puedes agregar mano de obra por persona/rol con su unidad (día/hora/servicio).
    </div>

    {{ formset.management_form }}

    <table>
      <thead>
        <tr>
          <th>Descripción</th>
          <th>Categoría</th>
          <th>Unidad</th>
          <th>Cantidad</th>
          <th>Precio</th>
          <th>Eliminar</th>
        </tr>
      </thead>
      <tbody>
        {% for f in formset %}
        <tr>
          {{ f.id }} <!-- IMPORTANTE: hidden id -->
          <td>{{ f.descripcion }}</td>
          <td>{{ f.categoria }}</td>
          <td>{{ f.unidad_pago }}</td>
          <td>{{ f.cantidad }}</td>
          <td>{{ f.precio_unitario }}</td>
          <td>
            {% if f.instance.pk %}
              {{ f.DELETE }}
            {% else %}
              -
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="row" style="margin-top:14px;">
      <button class="btn" type="submit">Guardar cambios</button>
      <a class="btn secondary" href="{% url 'cotizaciones:cotizacion_detail' cotizacion.id %}">Volver</a>
    </div>
  </form>
</div>

<div class="card">
  <div class="muted">
    Si necesitas más filas por defecto, cambia <b>extra</b> en <b>forms.py</b>.
  </div>
</div>
{% endblock %}
